## 信号在网线和集线器中传输

![image-20200324172537919](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200324172537919.png)

![image-20200324172611407](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200324172611407.png)

![image-20200328092351263](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200328092351263.png)

![image-20200325083759167](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325083759167.png)

![](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325103601986.png)

![image-20200325104115740](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325104115740.png)



## 交换机的包转发操作

![image-20200325104806242](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325104806242.png)

交换机根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口。

### MAC地址表的维护

- 收到包时，记录发送方的MAC地址和输入端口号
- 每过一段时间删除地址表中的记录

### 特殊情况

首先，计算机 A 发送的包到达集线器后会被集线器转发到所有端口上，也就是会到达交换机和计算机 B。 这时，交换机转发这个包之后，这个包会原路返回集线器，然后，集线器又把包转发到所有端口，于是这个包又到达了计算机 A 和计算机 B。所以计算机 B 就会收到两个相同的包，这会导致无法正常通信。因此，当交换机发现一个包要发回到原端口时，就会直接丢弃这个包。

![image-20200325112444285](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325112444285.png)

还有另外一种特殊情况，就是地址表中找不到指定的 MAC 地址。这 可能是因为具有该地址的设备还没有向交换机发送过包，或者这个设备一 段时间没有工作导致地址被从地址表中删除了。这种情况下，交换机无法 判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端 口上，无论该设备连接在哪个端口上都能收到这个包。这样做不会产生什 么问题，因为以太网的设计本来就是将包发送到整个网络的，然后只有相 应的接收者才接收包，而其他设备则会忽略这个包。



此外，如果接收方 MAC 地址是一个广播地址 ，那么交换机会将包发 送到除源端口之外的所有端口。



### 全双工模式

在全双工模式下，无需等待其他信号结束就可以发送信号，因此它比半双工模式速度要快 。由于双方可以同时发送数据，所以可同时传输的数据量也更大，性能也就更高。

![image-20200325120722569](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325120722569.png)

### 自动协商

自动在半双工和全双工模式中切换，探测对方的传输速率并进行自动切换。

在以太网中，当没有数据传输时，网络中会填充脉冲信号，用来将自身的状态（支持的工作模式和传输速率）告知对方。

![image-20200325121113530](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325121113530.png)



## 路由器的包转发操作

### 路由器的基本知识

![image-20200325121544913](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325121544913.png)

路由器的各个端口都具有 MAC 地址和 IP 地址。

### 路由表

- 路由器根据“IP 地址”判断转发目标。

- 路由器会忽略主机号，只匹配网络号。

- 路由表的子网掩码列只表示在匹配网络包目标地址时需要对比的比特数量。

- 路由器的端口都具有 MAC 地址，只接收与自身地址匹配的包， 遇到不匹配的包则直接丢弃。

- 通过路由器转发的网络包，其接收方 MAC 地址为路由器端口的 MAC 地址。

- 最长匹配原则：寻找网络号比特数最长的纪录。

- 网络号长度相同，则选择跃点计数小的纪录。

- 路由器遇到不知道该转发到哪里的包， 就会直接丢弃。

- 默认路由：子网掩码 0.0.0.0 的意思是网络包接收方 IP 地址和路由表目标地址的匹配中需要匹配的比特数为 0，换句话说，就是根本不需要匹配。只要 将子网掩码设置为 0.0.0.0，那么无论任何地址都能匹配到这一条记录。

  

![image-20200325135140917](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325135140917.png)

路由聚合

![image-20200325135811358](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200325135811358.png)

路由表的维护：

- 由人手动维护
- 根据路由协议（RIP OSPC BGP等），通过路由器之间的信息交换由路由器自行维护路由表记录

### 发送前

在路由表中查找到转发目标后，包会被转交给输出端口，发送出去，但在此之前，还有一些工作：

- 更新TTL
- 分片
- 重新计算校验和



一般来说都是可以分片的，但下面两种情况不能分片:

- 发送方应用程序 等设置了不允许分片
- 这个包已经是经过分片后的包。



### 发送

1. 判断要转发的IP地址是什么
   - 如果匹配的纪录中的网关列是一个IP地址，则这个IP地址就是要转发到的目标地址
   - 如果网关为空，IP头部中的接收方IP地址就是要转发到的目标地址
2. 通过ARP查询IP地址对应的MAC地址（APRP缓存）
3. 发送方MAC地址填写输出端口的MAC地址
4. 将网络包转换成电信号并通过端口发送出去



### 路由器和交换机的关系

IP（路由器）负责将包送达通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的。



## 路由器的附加功能

### 地址转换（NAT）

私有地址：

- 10.0.0.0 ～ 10.255.255.255
- 172.16.0.0 ~ 172.31.255.255
- 192.168.0.0 ~ 192.168.255.255

![image-20200326134720501](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200326134720501.png)



![image-20200326135354955](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200326135354955.png)

![image-20200326140100942](/Users/aimergenge/PersonalProjects/Notebook/网络是怎样连接的/从网线到网络设备/从网线到网络设备.assets/image-20200326140100942.png)